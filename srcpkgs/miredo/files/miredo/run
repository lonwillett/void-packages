#!/bin/sh
CONFFILE=/etc/miredo/miredo.conf
CHROOTOPT=""
IP="/sbin/ip"
TABLE="teredo"
RTTABLES="/etc/iproute2/rt_tables"

if egrep -qi '^[ 	]*RelayType[ 	][ 	]*(cone|relay|restricted)[ 	]*$' "$CONFFILE"; then
    # Teredo relay: chroot the process
    CHROOTOPT="-t /var/chroot/miredo"
elif [ -f "$RTTABLES" ] ; then
    # Teredo client: add entry to rt_tables if missing
    if ! "$IP" route show table "$TABLE" >/dev/null 2>&1; then
	i=0
	while [ $i -lt 252 ]; do
	    i=$((i+1))
	    if ! grep -q "^$i[ 	]" "$RTTABLES"; then
		echo "$i	$TABLE" >> "$RTTABLES"
		break
	    fi
	done
    fi
fi

exec /usr/sbin/miredo -f $CHROOTOPT
