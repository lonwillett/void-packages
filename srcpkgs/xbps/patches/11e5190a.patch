From 11e5190a36972ced2c0c79da9d6c00ecdbd75bfa Mon Sep 17 00:00:00 2001
From: Johannes Brechtmann <johannes@jnbr.me>
Date: Sat, 22 Jun 2019 16:40:49 +0200
Subject: [PATCH] lib/fetch: happy_eyeballs_connect check for waiting
 connections before decrementing them, remove dead code

---
 lib/fetch/common.c | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/lib/fetch/common.c b/lib/fetch/common.c
index df7f33dd..885fc743 100644
--- lib/fetch/common.c
+++ lib/fetch/common.c
@@ -609,6 +609,8 @@ happy_eyeballs_connect(struct addrinfo *res0, int verbose)
 			if (pfd[i].fd != -1)
 				pfd[i].events = POLLOUT;
 		}
+		if (!waiting)
+			break;
 		if ((ret = poll(pfd, attempts, timeout ? timeout : -1)) == -1) {
 			err = errno;
 			rv = -1;
@@ -639,10 +641,6 @@ happy_eyeballs_connect(struct addrinfo *res0, int verbose)
 			rv = -1;
 			break;
 		}
-		if (!waiting)
-			break;
-		else if (done)
-			goto wait;
 	}
 
 out:
